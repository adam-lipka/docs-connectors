= Microsoft Azure Service Bus Connector
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

Support Category: Select

Microsoft Azure Service Bus Connector version 2.0.0

The Azure Service Bus connector enables message integration with Azure Service Bus on the cloud. This connector supports communication with queues and topics. In addition, you can use the built-in management API to discover Azure Service Bus objects automatically and to provision them.

== Prerequisites

This document assumes that you are familiar with Mule, Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and Global Elements.

You need login credentials to test your connection with your target resource. You can use basic authentication, or you can pass credentials in a connection string.

For hardware and software requirements and compatibility
information, see the Connector Release Notes.

== To Connect in Anypoint Studio

=== Configuration
. To install a connector, see link:/getting-started/anypoint-exchange#installing-a-connector-from-anypoint-exchange[Installing a Connector from Anypoint Exchange].
. Drag and drop an HTTP Listener into the Studio canvas.
+
image::ms-azure/microsoft-azure-sb-listener.png[Trigger options]
+
. To create an HTTP Listener configuration for the connector, enter values for these fields:
+
image::ms-azure/microsoft-azure-sb-httpListenerConfig.png[Http Listener configuration]
+
.. Protocol: Protocol selected for the HTTP endpoint. This can be Http or HTTPS (secure).
.. Host: IP address where the Mule application listens for requests.
.. Port: Port address where the Mule application listens for requests.
.. Base Path: Path where the Mule app listens for requests.
. Select the Connector from palette.
+
image::microsoft-azure--sb-palette.png[add connector]
+
. Drag and drop the connector to the canvas.
. Configure one of global elements for the connector:
+
image::ms-azure/microsoft-azure-config.png[Configuration]
+
[%header%autowidth.spread]
|===
|===
+

.. *Basic authentication*
+
image::ms-azure/microsoft-azure--sb-userandpassword.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Key Name* | Name of the access key configured on the Azure Service Bus namespace. An access key created at a lower level, such as a topic-level shared key, does not work with this option unless you disable the connectivity test at startup.
|*Shared Access Key* | 56-bit primary key.
|*Service namespace*| Name of the service namespace to address Azure Service Bus resources within your application.

|===

.. *Connection string*
+
image::ms-azure/microsoft-azure--sb-cs.png[General]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Connection String* | link provided by the Microsoft Azure portal that contains all needed connection parameters.
|*Service Namespace* | Name of the service namespace to address Service Bus resources within your application.
|===

=== Sources

==== Queue Listener

.. Configuration
+
image::ms-azure/microsoft-azure-sb-queuereceiver.png[Queue Source]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Queue name* | Queue to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive Mode* | MANUAL: User must manually acknowledge messages or abandon them. Manual ACK messages or Abandon them. AUTOMATIC: Message is acknowledged from the queue and deleted from it when is received.
|*Server timeout (ms)*| Connection time in milliseconds to the server (it will wait until a message is available or returns null other case).
|*Prefetch count*| When Prefetch is enabled in any of the official Service Bus clients, the receiver acquires more messages, up to the PrefetchCount limit. This can be beyond what the application initially asked for. Set this field to 0 to disable prefetching.
|*Cron Expression*| (Optional) UNIX CRON expression that specifies when to trigger the receiver action. For example setting this field to `0 0 * * *`  triggers the receiver action at midnight (00:00) every day.
|*Max messages to receive*| Maximum number of messages to receive during the scheduled task.
|===

==== Subscription Listener

.. Configuration
+
image::ms-azure/microsoft-azure-sb-topicreceiver.png[Topic Source]
+
[%header%autowidth.spread]
|===
|Field |Description
|*Topic name* | Topic name to connect.
|*Subscription name*| Subscription to receive events. To receive events from the dead letter queue, specify `QueueName/$deadletterqueue`.
|*Receive Mode* | MANUAL: user has to Manual ACK messages or Abandon them. AUTOMATIC: message is ACK from queue and deleted from it when is received.
|*Server timeout (ms)*| Time interval for which the server waits for an available message. If the time interval elapses before a message is available, the server returns null.
|*Prefetch count*| When Prefetch is enabled in any of the official Service Bus clients, the receiver quietly acquires more messages, up to the PrefetchCount limit, beyond what the application initially asked for. Setting this to 0 will disable prefetching.
|*Cron Expression*| (Optional) UNIX cron expression that represent the time to trigger the receiver action. For example '0 0 * * *' (whitout quotes) will receive message at 00:00 every day.
|*Max messages to receive*| Maximum number of messages to receive during the scheduled task.
|===

== Use Case: Studio

=== Get Queue list

image::ms-azure/microsoft-sb-azure-flow.png[General]

. Create a new Mule app on Studio, and select an HTTP Listener as a source in the new flow.
. Add a new HTTP Listener Configuration global element:
.. Fill Host and port parameters with the following values:
+
[%header%autowidth.spread]
|===
|Parameter |Value
|*Host* |0.0.0.0
|*Port* |8081
|===
+
.. Click *Save*.
. Assign the Global configuration to the HTTP Listener.
. Add HTTP Listener path with `/list` value.
. Drag and drop a new *Azure Service Bus* component on the flow.
. Configure the Azure Service Bus connector global element with its environment values.
. Select `List queues` operation in the dropdown option.
* Save and run the project as a Mule Application.

[NOTE]
To test the app, navigate to `http://127.0.0.1:8081/list`

== Use Case: XML

[source,code]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:microsoft-azure-service-bus="http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus http://www.mulesoft.org/schema/mule/microsoft-azure-service-bus/current/mule-microsoft-azure-service-bus.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <microsoft-azure-service-bus:connection-string-config name="Microsoft_Azure_Service_Bus__Connection_string" connectionString="${config.cs}" namespace="${config.namespace}" doc:name="Microsoft Azure Service Bus: Connection string"/>
    <flow name="list-queue">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
        <microsoft-azure-service-bus:list-queues config-ref="Microsoft_Azure_Service_Bus__Connection_string" doc:name="list queues"/>
    </flow>
</mule>

----

== Additional information

=== Queue/Subscription listener operations

The output payload is a String with the message. Additional attributes are returned in the Outbound Properties.

=== Using restricted access policies

In cases where you have restrict access to your resources (only send/receive amqps messages), option inside the *Advanced* tab *AMQPS-only credentials* has to be checked.

== See Also

* Learn more about the Microsoft Azure Service Bus connector in the link:/mule-user-guide/v/3.8/microsoft-azure-service-bus-connector-faq[Microsoft Azure Service Bus Connector FAQ].
